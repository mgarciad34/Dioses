<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Gestion de pruebas</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">Gestión de Pruebas</a>
    <button
            class="navbar-toggler"
            type="button"
            data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent"
            aria-expanded="false"
            aria-label="Toggle navigation"
    >
        <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
            <!-- Opción del Navbar para redirigir a otro HTML -->
            <li class="nav-item">
                <a class="nav-link" href="caracteristicashumanos.html">Características del humano</a>
            </li>
        </ul>
    </div>
</nav>

<!-- Selector de Fetch -->
<select id="selectFetch" class="form-control mt-3">
    <option value="libres">Pruebas Libres</option>
    <option value="valoracion">Pruebas Valoracion</option>
    <option value="eleccion">Pruebas Eleccion</option>
</select>

<!-- Resultado del Fetch -->
<div id="resultadoFetch" class="mt-3"></div>

<!-- jQuery y Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
      // Limpiar el localStorage al cargar esta página
      localStorage.clear();
      const token = sessionStorage.getItem("token");

      const selectFetch = document.getElementById("selectFetch");

      selectFetch.addEventListener("change", function () {
          const id = sessionStorage.getItem("id_humano");
          const selectedValue = selectFetch.value;
          let url = "";

          if (selectedValue === "libres") {
              url = `http://localhost:8000/api/humano/obtener/pruebas/libres/${id}`;
          } else if (selectedValue === "valoracion") {
              url = `http://localhost:8000/api/humano/obtener/pruebas/valoracion/${id}`;
          } else if (selectedValue === "eleccion") {
              url = `http://localhost:8000/api/humano/obtener/pruebas/eleccion/${id}`;
          }

          const resultadoFetch = document.getElementById("resultadoFetch");

          fetch(url, {
              headers: {
                  Authorization: `Bearer ${token}`,
              },
          })
              .then((response) => response.json())
              .then((data) => {
                  if (data.length === 0) {
                      resultadoFetch.innerHTML = "<p>No tienes preguntas.</p>";
                  } else {
                      const table = document.createElement("table");
                      table.classList.add("table", "table-bordered");

                      const thead = document.createElement("thead");
                      const headerRow = document.createElement("tr");
                      const headers = ["ID", "Pregunta", "Estado"];
                      headers.forEach((headerText) => {
                          const th = document.createElement("th");
                          th.textContent = headerText;
                          headerRow.appendChild(th);
                      });
                      thead.appendChild(headerRow);
                      table.appendChild(thead);

                      const tbody = document.createElement("tbody");

                      data.forEach((item) => {
                          const tr = document.createElement("tr");
                          Object.values(item).forEach((value, index) => {
                              if (index !== 3 && index !== 4) {
                                  const td = document.createElement("td");
                                  if (index === 2) {
                                      if (value === 0) {
                                          td.textContent = "Superado";
                                          // Si el estado es Superado, deshabilitar el botón
                                          tr.classList.add("superado");
                                      } else if (value === 1) {
                                          td.textContent = "No Superado";
                                          // Si el estado es No Superado, deshabilitar el botón
                                          tr.classList.add("no-superado");
                                      } else {
                                          td.textContent = "Pendiente de realizar";
                                      }
                                  } else {
                                      td.textContent = value;
                                  }
                                  tr.appendChild(td);
                              }
                          });

                          const tdActions = document.createElement("td");
                          const responderButton = document.createElement("button");
                          responderButton.textContent = "Responder Pregunta";
                          responderButton.classList.add("btn", "btn-primary", "btn-sm");

                          if (item.acciones === 0 || tr.classList.contains("superado") || tr.classList.contains("no-superado")) {
                              responderButton.disabled = true;
                          }

                          responderButton.addEventListener("click", function () {
                              localStorage.setItem("respuesta", JSON.stringify(item));
                              if (selectedValue === "libres") {
                                  window.location.href = "respuestapruebaslibres.html";
                              } else if (selectedValue === "eleccion") {
                                  window.location.href = "respuestaeleccion.html";
                              } else if (selectedValue === "valoracion") {
                                  window.location.href = "respuestavaloracion.html";
                              }
                          });
                          tdActions.appendChild(responderButton);
                          tr.appendChild(tdActions);

                          tbody.appendChild(tr);
                      });
                      table.appendChild(tbody);

                      resultadoFetch.innerHTML = "";
                      resultadoFetch.appendChild(table);
                  }
              })
              .catch((error) => {
                  resultadoFetch.innerHTML = `Error: ${error}`;
              });
      });

      // Dispatch the change event manually to load the initial table
      selectFetch.dispatchEvent(new Event('change'));
  });
</script>

</body>
</html>
