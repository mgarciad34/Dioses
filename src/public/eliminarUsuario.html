<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Eliminar Usuarios</title>
    <!-- Asegúrate de incluir la biblioteca de Bootstrap -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    />
    <!-- Estilos personalizados -->
    <style>
      body {
        background-image: url("https://img.freepik.com/vector-gratis/ilustracion-mitologia-diseno-plano-dibujado-mano_23-2149391243.jpg?w=740&t=st=1706826016~exp=1706826616~hmac=4892d2e5e6f3fda1024db0e03ebc53a84987dbe659aa46f8db77cb6e158a6ced");
        /* Reemplaza 'tu_imagen_de_fondo.jpg' con la URL de tu imagen de fondo */
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        height: 100vh;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .btn-group {
        margin-top: 10px;
        /* Ajusta el espacio entre el select y los botones */
      }

      /* Estilos para la tabla con Bootstrap */
      .table-responsive {
        width: 100%;
        overflow-x: auto;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="row">
        <div class="col-md-8 offset-md-2 text-center">
          <div class="btn-group">
            <h1>Elimina a tus humanos</h1>
            <button type="button" class="btn btn-danger" id="eliminarTodosBtn">
              Eliminar Todos
            </button>
          </div>

          <div class="table-responsive">
            <table class="table table-bordered table-striped mt-3">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="tablaUsuariosBody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      let token;

      function cargarDatosDesdeAPI() {
        token = sessionStorage.getItem("token");

        if (!token) {
          console.error("No se encontró un token en sessionStorage");
          return;
        }

        fetch("http://127.0.0.1:8000/api/dioses/recuperar/humanos", {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                `Error en la solicitud: ${response.status} ${response.statusText}`
              );
            }

            return response.json();
          })
          .then((data) => {
            console.log("Respuesta de la API:", data);

            const tablaUsuariosBody =
              document.getElementById("tablaUsuariosBody");

            tablaUsuariosBody.innerHTML = "";

            const humanosConVida = data.data.filter(
              (humano) => humano.vida === 1
            );

            humanosConVida.forEach((humano) => {
              const fila = tablaUsuariosBody.insertRow();

              const celdaId = fila.insertCell(0);
              const celdaNombre = fila.insertCell(1);
              const celdaAcciones = fila.insertCell(2);

              celdaId.textContent = humano.id;
              celdaNombre.textContent = humano.nombre;

              fila.setAttribute("data-id", humano.id);

              const btnEliminar = document.createElement("button");
              btnEliminar.textContent = "Eliminar";
              btnEliminar.classList.add("btn", "btn-danger");
              btnEliminar.onclick = function () {
                eliminarUsuario(humano.id);
              };
              celdaAcciones.appendChild(btnEliminar);
            });
          })
          .catch((error) =>
            console.error("Error al cargar datos desde la API:", error)
          );
      }

      function eliminarUsuario(idUsuario) {
        const confirmacion = confirm(
          `¿Estás seguro de que quieres eliminar al usuario con ID ${idUsuario}?`
        );

        if (confirmacion) {
          const url = `http://127.0.0.1:8000/api/dioses/eliminar/humano/${idUsuario}`;

          fetch(url, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error(
                  `Error en la solicitud: ${response.status} ${response.statusText}`
                );
              }

              const filaEliminar = document.querySelector(
                `#tablaUsuariosBody tr[data-id="${idUsuario}"]`
              );
              if (filaEliminar) {
                filaEliminar.remove();
                console.log(
                  `Usuario con ID ${idUsuario} eliminado exitosamente.`
                );
              } else {
                console.error(
                  `No se encontró la fila del usuario con ID ${idUsuario}.`
                );
              }
            })
            .catch((error) =>
              console.error("Error al eliminar usuario:", error)
            );
        }
      }

      function eliminarAleatorio() {
        const filas = document.querySelectorAll("#tablaUsuariosBody tr");

        if (filas.length > 0) {
          const indiceAleatorio = Math.floor(Math.random() * filas.length);

          const idUsuarioAleatorio =
            filas[indiceAleatorio].getAttribute("data-id");

          const confirmacion = confirm(
            `¿Estás seguro de que quieres eliminar al usuario con ID ${idUsuarioAleatorio}?`
          );

          if (confirmacion) {
            const url = `http://127.0.0.1:8000/api/dioses/eliminar/humano/${idUsuarioAleatorio}`;

            fetch(url, {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            })
              .then((response) => {
                if (!response.ok) {
                  throw new Error(
                    `Error en la solicitud: ${response.status} ${response.statusText}`
                  );
                }

                const filaEliminar = document.querySelector(
                  `#tablaUsuariosBody tr[data-id="${idUsuarioAleatorio}"]`
                );
                if (filaEliminar) {
                  filaEliminar.remove();
                  console.log(
                    `Usuario con ID ${idUsuarioAleatorio} eliminado exitosamente.`
                  );
                } else {
                  console.error(
                    `No se encontró la fila del usuario con ID ${idUsuarioAleatorio}.`
                  );
                }
              })
              .catch((error) =>
                console.error("Error al eliminar usuario:", error)
              );
          }
        } else {
          alert("No hay usuarios para eliminar.");
        }
      }

      cargarDatosDesdeAPI();

      document
        .getElementById("eliminarTodosBtn")
        .addEventListener("click", eliminarAleatorio);
    </script>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  </body>
</html>
